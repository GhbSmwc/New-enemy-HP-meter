<html>
	<head>
		<style>
			html {
			background-color: #101010;
			color: rgb(221, 221, 221);
			font-family: sans-serif;
			}
			
			table, th, td {
			border: 1px solid white;
			border-collapse: collapse;
			}
			
			span.NoLineBreak {
				white-space: nowrap;
			}
			
			abbr{cursor: help;}
			img.img-hor {
				-moz-transform: scaleX(-1);
				-o-transform: scaleX(-1);
				-webkit-transform: scaleX(-1);
				transform: scaleX(-1);
				filter: FlipH;
				-ms-filter: "FlipH";
			}
			div.CodeBlock {
				overflow: auto;
				width: 1000px;
				height: 500px;
				border: 1px solid white;
				resize: both;
				background-color: #101010;
			}
			pre {
				margin: 0px;
			}
			*.FixedWidth {
				font-family: monospace;
			}
			
			*.NoLineBreak {
				font-family: monospace;
				white-space: pre;
			}
			*.Center {
				text-align: center;
			}
			
			li {
				padding: 5px;
			}
			tr.RedBackground {
				background-color: #400000;
			}
		</style>
	</head>
<body style="max-width: 1000px; margin: auto; padding: 15px">
<h1 class="Center">Enemy HP patch</h1>
<div class="Center">By HammerBrother</div>
<div>
	<p>This ASM resource displays the enemies' HP as a numerical value and/or as a bar when they take damage on the status bar/HUD.</p>
	<p>This is similar to <i>Kirby & The Amazing Mirror</i>. With the differences being:</p>
	<ul>
		<li>The bar in this resource displays its current HP percentage and its previous HP via a rapid-flicker. In K&tAM, the bar
		updates with a gradual decrease without showing the previous HP percentage.</li>
		
		<li>Touching enemies will not display the meter, in K&tAM, it is possible to make it show its HP without damaging the enemy
		by having Sone Kirby in his stone form (not moving or rolling down slopes) and an enemy passes by.</li>
	</ul>
	<p>So few enemies in SMW can take damage without being one-shotted, they are Chucks, Wendy/Lemmy, Ludwig, Morton/Roy, Big Boo boss,
	and Bowser (although the status bar in that battle is disabled)</p>
</div>
<hr>
<div>
	<h2>Table of contents</h2>
	<ul>
		<li><a href="#JMPTo_HowtoInsert" id="ToC_HowtoInsert">How to insert</a></li>
		<li><a href="#JMPTo_RAMUsage" id="ToC_RAMUsage">RAM usage documentation</a></li>
		<li><a href="#JMPTo_ProgrammingHPForCustomSprites" id="ToC_ProgrammingHPForCustomSprites">How to program the HP system to your custom sprites</a></li>
		<ul>
			<li><a href="#JMPTo_ProgrammingHPForCustomSprites_BossIntroFill" id="ToC_ProgrammingHPForCustomSprites_BossIntroFill">Boss intro-fill</a></li>
			<li><a href="#JMPTo_ProgrammingHPForCustomSprites_ConvertTotalDamageToHP" id="ToC_ProgrammingHPForCustomSprites_ConvertTotalDamageToHP">Convert Damage Counter to HP</a></li>
			<li><a href="#JMPTo_ProgrammingHPForCustomSprites_TakingDamage" id="ToC_ProgrammingHPForCustomSprites_TakingDamage">Damage handler</a></li>
		</ul>
	</ul>
</div>
<div>
	<h2>What you need</h2>
	<ul>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=17109">Lunar magic</a></li>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=14560">Asar</a></li>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=39036">Uberasm tool version 2.0 or higher</a> (latest version recommended)</li>
		<li>Status bar patches, this ASM package by default assumes you are using the <a href="https://www.smwcentral.net/?p=section&a=details&id=19247">super status bar patch</a>.</li>
	</ul>
	<h2>Recommended</h2>
	<ul>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=37432">Pixi</a></li>
	</ul>
	<h2>Documentations of other ASM resources</h2>
	<ul>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=38296">Status bar tutorial (contains string system and number display)</a></li>
		<li><a href="https://www.smwcentral.net/?p=section&a=details&id=38297">Graphical Bar</a></li>
	</ul>
</div>
<hr>
<div>
	<h2><a href="#ToC_HowtoInsert" id="JMPTo_HowtoInsert">^</a>How to insert</h2>
	<ol>
		<li>ASM stuff</li>
		<ol>
			<li>Make any changes necessary on the defines, especially freeram data. It is likely that you would have them take up a large amount of bytes due to
			them being sprite tables. There are multiple files due to some resources are general-purpose, such as the graphical bar can be used for player's HP
			or other meters besides HP. The defines specific to sprite HP are in <kbd>EnemyHPMeterDefines.asm</kbd>. For editing what tiles used by general-purpose
			subroutines, they're in <kbd>NumberDisplayRoutinesDefines.asm</kbd>.<br><br>
			
			Once you are done, you'll need to have copies of these txt files (not the folder itself containing the texts) in same directory as the tools'
			<kbd>.exe</kbd> programs are at (pixi and uberasm tool). Do not have them in any subfolders beyond that area. Make sure you do not move the define files
			as the patch will include those define files (better to copy than to cut them).<br><br>
			
			If you later make changes in any of the defines and reinsert in one tool, make sure you update all others and reinsert in other tools.</li>
			
			<li>Patch <kbd>HPSystemForSMWSprites.asm</kbd> to your game. This adds a proper health system for some sprites and bosses and fixes an anomoly for SMW*.
			This alone does not display meter, but will write to various RAM for the uberasm tool code to display it.<br><br>
			
			*The anomoly is that while SMW does stores a number representing how many hits enemies have taken, the fact that all attack types (specifically, fireballs and stomp)
			increases this counter by the same amount, 1, and when this value hits various values <i>depending what attack type as the last hit</i>, would trigger the death sequence.</li>
			
			<li>Insert the ASM files to Uberasm tool. The provided folders should be obvious.</li>
			
			<li>Same with pixi, if you want custom sprites. I provided a test sprite in the foloder for demonstration.</li>
		</ol>
		<li>Lunar Magic stuff</li>
		<ol>
			<li>In all levels accessible by the player, insert the layer 3 status bar ExGFX by &ldquo;Quick Extract ExGFX from ROM&rdquo; (blue mushroom icon) to spawn a <kbd>ExGraphics</kbd> (unless you did so already), then,
			inside this ASM resource, navigate to <kbd>LM stuff/ExGraphics</kbd>. Here you'll find a graphic file (uses ExGFX slot $80 by default, rename to have it at a different slot number). This file should
			be pasted in the ExGraphics of your game file. To insert into your game, &ldquo;Quick Insert ExGFX to ROM&rdquo; (golden mushroom). Finally, &ldquo;Open "Layer 3 GFX/Tilemap Bypass" Dialog&rdquo; (green
			poison mushrrom), and set LG1 to use your inserted graphics file (by default, should be $80 if you didn't change the slot number)<br><br>
			
			This graphic is for layer 3 status bar, since some symbols needed for the display are missing. The tiles used are the slash (&ldquo;/&rdquo;) and graphical bar tiles.
			
			</li>
		</ol>
	</ol>
</div>
<hr>
<div>
	<h2><a href="#ToC_RAMUsage" id="JMPTo_RAMUsage">^</a>RAM usage documentation</h2>
		<p>
			Notes:
			<ul>
				<li>Define <kbd>!sprite_slots</kbd> is the number of sprite slots that exists. For LoROM, its 12, if SA-1, its 22.</li>
			</ul>
		</p>
		<p>Other than the RAM data for graphical bar and HexDec routines (defines are in <kbd>GraphicalBarDefines.asm</kbd> and <kbd>NumberDisplayRoutinesDefines.asm</kbd>), the sprite HP data and display handler are in <kbd>EnemyHPMeterDefines.asm</kbd>,
		defined as <kbd>!Freeram_SpriteHP_SpriteHPData</kbd>. It's layout are (in this order, starting at an address defined as <kbd>!Freeram_SpriteHP_SpriteHPData</kbd>, and advancing to higher-addressees):
		<table>
			<tr>
				<th>Define</th>
				<th><abbr title="&ldquo;State&rdquo; refers to an individual value representing the state of something, &ldquo;Sprite slots&rdquo; are tables that each byte correspond to a sprite slot, which is how multiple entities can exists.">Type</abbr></th>
				<th>Number of bytes</th>
				<th>Description</th>
				<th>Use condition</th>
			</tr>
			<tr>
				<th><kbd>!Freeram_SpriteHP_MeterState</kbd></th>
				<td class="Center">State</td>
				<td class="NoLineBreak Center">1</td>
				<td>Sprite slot number (ranges from <kbd>$00</kbd> to <kbd>!sprite_slots-1</kbd>) to represent HP of that sprite. <kbd>$FF</kbd> will not display the meter. When having both <kbd>!Setting_SpriteHP_DisplayGraphicalBar</kbd> and <kbd>!Setting_SpriteHP_BarAnimation</kbd> set to <kbd>1</kbd>,
				more values of that RAM are used (ranging from <kbd>!sprite_slots</kbd> to <kbd>(!sprite_slots*2)-1</kbd>, each value here corresponds to slot like the range before) for the &ldquo;intro-fill&rdquo; mode (used for an animation that plays when a boss appears, the bar appears with it filling from 0% to 100%)</td>
				<td>Always</td>
			</tr>
			<tr>
				<th><kbd>!Freeram_SpriteHP_CurrentHPLow</kbd></th>
				<td class="Center">Sprite slots</td>
				<td class="NoLineBreak Center">!sprite_slots</td>
				<td>Sprite's current HP, low byte.</td>
				<td>Always</td>
			</tr>
			<tr>
				<th><kbd>!Freeram_SpriteHP_MaxHPLow</kbd></th>
				<td class="Center">Sprite slots</td>
				<td class="NoLineBreak Center">!sprite_slots</td>
				<td>Sprite's maximum HP, low byte.</td>
				<td>Always</td>
			</tr>
			<tr class="RedBackground">
				<th><kbd>!Freeram_SpriteHP_CurrentHPHi</kbd></th>
				<td class="Center">Sprite slots</td>
				<td class="NoLineBreak Center">!sprite_slots</td>
				<td>Sprite's current HP, high byte.</td>
				<td>if <kbd>!Setting_SpriteHP_TwoByte</kbd> is set to <kbd>1</kbd></td>
			</tr>
			<tr class="RedBackground">
				<th><kbd>!Freeram_SpriteHP_MaxHPHi</kbd></th>
				<td class="Center">Sprite slots</td>
				<td class="NoLineBreak Center">!sprite_slots</td>
				<td>Sprite's maximum HP, high byte.</td>
				<td>if <kbd>!Setting_SpriteHP_TwoByte</kbd> is set to <kbd>1</kbd></td>
			</tr>
			<tr class="RedBackground">
				<th><kbd>!Freeram_SpriteHP_BarAnimationFill</kbd></th>
				<td class="Center">Sprite slots</td>
				<td class="NoLineBreak Center">!sprite_slots</td>
				<td>The secondary fill amount used for the animation of the bar fill going up and down. This does so by using a rapid-flicker to show the difference between current HP fill and previous HP fill. If intro-fill mode is
				active, will only show the filling up animation.</td>
				<td>if <kbd>!Setting_SpriteHP_DisplayGraphicalBar</kbd> and <kbd>!Setting_SpriteHP_BarAnimation</kbd> is set to <kbd>1</kbd></td>
			</tr>
			<tr class="RedBackground">
				<th><kbd>!Freeram_SpriteHP_BarAnimationTimer</kbd></th>
				<td class="Center">Sprite slots</td>
				<td class="NoLineBreak Center">!sprite_slots</td>
				<td>Delay timer that decreases itself once per frame. When nonzero, <kbd>!Freeram_SpriteHP_BarAnimationFill</kbd> briefly freezes
				before incrementing or decrementing to its current HP fill amount.</td>
				<td>if <kbd>!Setting_SpriteHP_DisplayGraphicalBar</kbd>, <kbd>!Setting_SpriteHP_BarAnimation</kbd>, and <kbd>!Setting_SpriteHP_BarChangeDelay</kbd> is set to nonzero values.</td>
			</tr>
		</table><br>
		Anything with a red background indicates those are optional features you can disable and will not be used.
		</p>
	<hr>
	<h2><a href="#ToC_ProgrammingHPForCustomSprites" id="JMPTo_ProgrammingHPForCustomSprites">^</a>How to program the HP system to your custom sprites</h2>
	<p>Note that this section assumes you know how to program in 65c816 assembly language. <a href="https://www.smwcentral.net/?p=section&a=details&id=14268">See this tutorial</a> on how to get started.</p>
	
	<p>To program a health system for existing custom sprites, they should store a value representing how much damage (can be any value it increases), hits (counts up by one reguardless of an attack), or
	remaining health (starts at any nonzero value and decreases each damage) else the sprite will never die or dies in one hit. Because each sprite is different, documenting every one of them would make
	this tutorial very long. So I'll explain the principals and with some examples.</p>
	
	<p>I provided an example test sprite under <kbd>pixi/sprites/simple_sprite.asm</kbd> for testing the HP system.</p>
	
	<h3><a href="#ToC_ProgrammingHPForCustomSprites_BossIntroFill" id="JMPTo_ProgrammingHPForCustomSprites_BossIntroFill">^</a>Boss intro-fill</h3>
	<p>For boss sprites, to have an &ldquo;intro-fill&rdquo; effect (meter automatically appears empty and fills up at the start of a fight), run this code under a sprite init (or under main but make sure
	it does not execute every frame, this method is useful if you want the animation after a cutscene after the sprite spawns). Note that you must have <kbd>!Setting_SpriteHP_DisplayGraphicalBar</kbd> and
	<kbd>!Setting_SpriteHP_BarAnimation</kbd> be set to 1:
<div class="CodeBlock" style="height: 250px;"><pre>
	;Have the following as an option on your custom sprite if you are willing to submit it to SMWC.
		!IntroFill = 1                                                      ;&gt;0 = no, 1 = yes (switch display to boss sprite with filling animation or simply a full bar if animation disabled).
	

	if !IntroFill
		if and(!Setting_SpriteHP_DisplayGraphicalBar, !Setting_SpriteHP_BarAnimation)
			TXA                                                 ;\Take the sprite slot number of the currently processed sprite, add by #!SprSize (12 for LoROM or 22 for SA-1),
			CLC                                                 ;|to set the meter state to the corresponding slot number but in "intro-fill" mode (not to show rapid-flicker healing animation)
			ADC.b #!SprSize                                     ;|&gt;Pixi stores the number of sprite slots as a define !SprSize
			STA !Freeram_SpriteHP_MeterState                    ;/
			LDA #$00                                            ;\Set the bar to initally show empty
			STA !Freeram_SpriteHP_BarAnimationFill,x            ;/
			if !Setting_SpriteHP_BarChangeDelay
				STA !Freeram_SpriteHP_BarAnimationTimer,x   ;&gt;Zero out the pause timer of the animation so that it plays the SFX of the filling animation properly.
			endif
		else
			TXA                                                 ;\If no animation, just simply switch to the boss's HP meter automatically.
			STA !Freeram_SpriteHP_MeterState                    ;/
		endif
	endif</pre></div>
	</p>
	<h3><a href="#ToC_ProgrammingHPForCustomSprites_ConvertTotalDamageToHP" id="JMPTo_ProgrammingHPForCustomSprites_ConvertTotalDamageToHP">^</a>Convert Damage Counter to HP</h3>
	<p>When a custom sprite stores a number (<kbd>DamageCount</kbd>) that starts at 0, and increases (commonly by 1 as a hit counter) for each hit the sprite recieves, HP can be found by
	taking the amount of damage needed to defeat the enemy, and subtract that by <kbd>DamageCount</kbd> to obtain the remaining damage needed to defeat the sprite:
<div class="CodeBlock" style="height: 250px;"><pre>
	macro ConvertDamageAmountToHP(HitCountSpriteTableRAM, DamageAmountToDie)
		LDA.b #&lt;DamageAmountToDie&gt;                                      ;&gt;The amount of damage that would kill the sprite
		STA !Freeram_SpriteHP_MaxHPLow,x                                ;&gt;This also means its maximum health is this value.
		SEC                                                             ;\RemainingHP = DamageAmountToDie - DamageCount
		SBC &lt;HitCountSpriteTableRAM&gt;,x                                  ;|
		STA !Freeram_SpriteHP_CurrentHPLow,x                            ;/
		if !Setting_SpriteHP_TwoByte != 0
			LDA #$00                                                ;\Rid high bytes.
			STA !Freeram_SpriteHP_CurrentHPHi,x                     ;|(So far, there is never a sprite that stores a 16-bit damage counter)
			STA !Freeram_SpriteHP_MaxHPHi,x                         ;/
		endif
	endmacro
	
	;In anywhere on the sprite's code that runs every frame (prefebly at the start of its "main" code)
	;you call the macro that contains code calculating its remaining HP, for example, for Chargin Chucks,
	;It's hit count is RAM $1528 (used as !1528,x for SA-1 and LoROM compatibility), so it's called like
	;this:
		%ConvertDamageAmountToHP(!1528, 15)
</pre></div>
	Now note, this is assuming you've patched <kbd>HPSystemForSMWSprites.asm</kbd> into your game. Reason for modifying bosses and enemies that take damage from fireballs and stomps is because of how janky it is.<br><br>
	
	Take for example, Chargin Chucks. Logically, it takes 5 fireballs to kill or 3 stomps to kill, you'd think the fireballs would deal less damage than a stomp attack (because more hits to kill means it deals
	less damage on the same amount of HP). But it doesn't work like that, internally, SMW will always increases the damage counter by 1 reguardless if the attack is a fireball or a stomp
	attack, and to tell if it reaches the amount of damage needed to kill the sprite, that amount itself depends on the last hit being a fireball (5 or more) or stomp attack (3 or more).
	Therefore techinically Chucks will take the same amount of damage of either the fireball or stomp, and the death condition is if after the last hit, the damage counter is 5 or more from a
	fireball, or 3 or more from the stomp attack.<br><br>
	
	The same also applies to Ludwig, Morton, and Roy. 12 fireballs or 3 stomps.<br><br>
	
	As a speedrunner trick, you can quickly kill Chucks, Ludwig, Morton, and Roy by shooting 2 fireballs (which ignores the temporary invulnerability state after taking damage), then jumping on them.<br><br>
	
	The patch modifies this to work as an actual damage system. Damages from fireballs and stomps deal different amounts, and there is only one value (reguardless of attack type) that if the damage counter reaches or exceeds it, kills the sprite.
	By default, Chucks needed 15 or more points of damage to defeat, fireballs deal 3 damage and stomps deal 5. And for Ludwig, Morton, and Roy, they needed 12 points to defeat, with fireballs dealing 1 damage, and Stomp attacks dealing 4.
	All of these preserves the amount of same-attack-types hits to be the same as vanilla.
	</p>
	<h2><a href="#ToC_ProgrammingHPForCustomSprites_TakingDamage" id="JMPTo_ProgrammingHPForCustomSprites_TakingDamage">^</a>Damage handler</h2>
	<p>Like I said before, the sprite having HP/Damage system must have something that would track the amount health or damage when a hit occurs, else it would take one hit to kill or have infinite HP. Thankfully most sprites have comments in their
	ASM codes that tell you what the codes do. However, this isn't just changing the HP amounts when the sprite takes damage or heals, if you want the meter to have animation (<kbd>!Setting_SpriteHP_BarAnimation</kbd> set to <kbd>1</kbd>), you also
	need to handle the meter animation. Thankfully, all that logic is handled in a subroutine called <kbd>SpriteLoseHP</kbd> along with that calling <kbd>SpriteHP_RemoveRecordEffect</kbd> and other stuff to show to the player the damage amount.
	Feel free to check out the subroutines as you wish.</p>
	
	<p>If you want to know how it works, just open the provided custom sprite's asm file or view the provided patch and seeing the SMW disassembly. Please note that, because patches, uberasm tool, and pixi have their own isolated subroutines system,
	and I don't want to have duplicate subroutines, the patch version on handling the bar animation is very different, it does not calculate via RAM on how many pieces are in the bar to determine, rather a pre-calculated number of pieces in the bar.</p>
	
	<p>If you're dealing with an incremental damage counter-type HP for bosses and wanted a damage animation, you would do the same thing, just make sure the how much it increases are stored in <kbd>$00</kbd> (<kbd>$00~$01</kbd> if <kbd>!Setting_SpriteHP_TwoByte == 1</kbd>), for example,
	the <a href="https://www.smwcentral.net/?p=section&a=details&id=13144">Giant Masked Koopa boss</a>:
<div class="CodeBlock" style="height: 70px;"><pre>
    INC !1534,x                 ; increment sprite hit counter
    LDA !1534,x                 ;\ If it has incremented to the "max", do death animation.
    CMP.b #!HitPoints           ; |
    BEQ SpriteDead              ;/
</pre></div>
	Should be changed to:
<div class="CodeBlock" style="height: 230px;"><pre>
    INC !1534,x                 ; increment sprite hit counter (this counts the damage up by 1)
    if !Setting_SpriteHP_TwoByte
        REP #$20
        LDA #$0001
        STA $00
        SEP #$20
    else
        LDA #$01
        STA $00
    endif
    %SpriteLoseHP()             ;Reflect the damage over to the sprite HP data (yes, the HP data is already synced via macro call of "ConvertDamageAmountToHP", however this may only happen before this code, which may cause 1-frame off-sync)
    LDA !1534,x                 ;\ If it has incremented to the "max", do death animation.
    CMP.b #!HitPoints           ; |
    BEQ SpriteDead              ;/
</pre></div>
	</p>
</div>
<script>
//These makes all <pre>...</pre> have an effect that double-clicking will select all the text
//in it, to make it easy to copy code and paste it in your ASM stuff.
//
//Credit:
// https://keestalkstech.com/2014/04/click-to-select-all-on-the-pre-element/
// https://www.sanwebe.com/2014/04/select-all-text-in-element-on-click
document.addEventListener('dblclick', e => {
  let pre = getClosest(e.target, "PRE");
  if (pre && e.ctrlKey) {
    let range = new Range();
    range.selectNodeContents(pre);
    document.getSelection().removeAllRanges();
    document.getSelection().addRange(range);
  }
});

function getClosest(el, tagName) {
  tagName = tagName && tagName.toUpperCase();

  if (!tagName || !el)
    return null;

  do
    if (el.nodeName === tagName)
      return el;
  while (el = el.parentNode);

  return null;
}
</script>